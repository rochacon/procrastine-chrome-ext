<style>
    body {
        font-family: Monaco;
        min-width: 375px;
        max-width: 1000px;
        overflow-x: hidden;
    }

    h1 {
        font-size: 14pt;
        margin: 0 auto;
        text-align: center;
    }

    #urls { 
        list-style-type: none;
        padding: 0px;
        margin: 0px;
    }
    
    #urls li.error {
        color: red;
    }

    #error {
        color: red;
        padding: 3px;
        display: none;
    }

    #api_key {
        display: none;
    }

    #api_key input[type=text] {
        width: 74%;
    }
   
    #add_url {
        text-align: center;
    }

    #add_url input[type=text] {
        width: 80%;
    }
</style>
<h1>
    procrastine
    <a href="#" id="logout">logout</a>
</h1>
<div id="error"></div>
<form id="add_url" method="POST" action="/add/">
    <input type="text" name="url">
    <input type="submit" value="Add">
</form>
<button id="reloadList">update list</button>
<ul id="urls"></ul>
<div id="api_key">
    <input type="text" name="api_key">
    <input type="button" value="Set API key">
</div>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.6.2/jquery.min.js"></script>
<script>
    /*
     * Check if API key entered (localStorage)
     *  if not: ask for api_key
     *  else: request list
     *
     *
     * Botoes:
     *   adicionar
     *   remover
     *
     */
    $(function(){
        var BASE_BASEURL = "https://procrastine.ep.io/";
        var BASE_URL = "";

        // Add a new URL
        function addUrl(){
            var button = $("input[type=submit]").attr("disabled", true).val('Saving...');
            var url = $.trim($("input[name=url]").val());
            if (url.length) {
                $.post(BASE_URL +"/add/", {'url': url}, function(json){
                    if (json.status === 200) {
                        addUrlToTheList(json.link);
                        $("input[name=url]").val('');
                    } else {
                        showError(json.message);
                    }
                    button.attr("disabled", false).val('Add');
                },"json"); 
            }
            return false;
        }
        $("#add_url").live('submit', addUrl);

        // Add a url list item 
        function addUrlToTheList(json) {
            var li  = "<li style='display:none;'>";
                li += "<button type='button' class='remove' data-id='"+ json.id +"'>X</button>"; 
                li += "<a href='"+ json.url + "' target='blank' data-id='"+ json.id +"'>";
                li += json.url +"</a></li>";
            $("#urls").prepend($(li).fadeIn());
        }

        // Update the list of urls
        function updateList() {
            $.post(BASE_URL +"/list/", null, function(json){
                var urls = $("#urls");
                if (json.status === 200) {
                    if (json.urls.length) {
                        urls.html('');
                        for (k in json.urls) {
                            addUrlToTheList(json.urls[k]);
                        }
                    } else {
                        // urls.append("<li class='empty'>"+ json.message +"</li>");
                    }
                } else {
                    urls.append("<li class='error'>"+ json.message +"</li>");
                }
            },"json");
        }

        // Set a API key to the localStorage
        function setApiKey() {
            var api_key = $.trim($("input[name=api_key]").val());
            if (api_key.length) {
                var sha1 = RegExp("^[a-f0-9]{40}$");
                if (sha1.test(api_key)) {
                    $("#api_key").fadeOut();
                    localStorage.setItem('api_key', api_key);
                    BASE_URL = BASE_BASEURL + api_key;
                    updateList();
                    $("#add_url").show();
                    $("#reloadList").show();
                    $("#logout").show();
                } else {
                    showError('Invalid API Key');
                }
            } else {
                showError('Error !!');
            }
        }
        $("#api_key input[type=button]").click(setApiKey);

        // Forget the Api Key and show the set api key form
        function clearApiKey(e) {
            localStorage.removeItem('api_key');
            $("#add_url").hide();
            $("#reloadList").hide();
            $("#logout").hide();
            $("#api_key").show();
        }
        $("#logout").click(clearApiKey);

        // Show confirmation in place
        var old_confirm_html;
        function confirm_inline(where, message, no_callback, yes_callback) {
            old_confirm_html = where.html();
            where.html(message);
            where.append($("<button></button>").html("No").click(no_callback));
            where.append($("<button></button>").html("Yes").click(function(){
                $(this).attr("disabled", true);
                yes_callback();
            }));
        }

        // Remove click event
        $(".remove").live('click', function(){
            var button = $(this);
            var li = $(this).parent();
            confirm_inline(li, "remove 4ever?", function(){
                li.html(old_confirm_html);
            },function(){
                removeUrl(button.data('id'), li);
            }); 
            
        });
        
        // remove a URL forever
        function removeUrl(id, li) {
            $.post(BASE_URL +"/remove/", {'id': id}, function(json){
                if (json.status === 200) {
                    li.fadeOut("normal", function(){ $(this).remove(); });
                } else {
                    showError(json.message);
                }
            },"json");
        }

        // Initialize
        var api_key = localStorage.getItem('api_key');
        if (api_key === null) {
            $("#add_url").hide();
            $("#reloadList").hide();
            $("#logout").hide();
            $("#api_key").show();
        } else {
            BASE_URL = BASE_BASEURL + api_key;
            $("#api_key").hide();
            updateList();
        }

        $("#reloadList").click(updateList);

        // Show a error message for X seconds 
        function showError(message, timeout) {
            if (timeout === null || timeout === undefined) {
                timeout = 5000;
            } else {
                timeout *= 1000;
            }
            $("#error").html(message).fadeIn(5000, function(){
                setTimout(function(){
                    $("#error").fadeOut();
                }, timeout);
            });
        }
    });
</script>
<script>
    // Set the current URL to the input
    chrome.tabs.getCurrent(function(t){
        //document.querySelector("input[name=url]").value = t.url;
    });
</script>

